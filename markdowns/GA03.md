# API Logging
## 1. Install morgan and winston
- Morgan is a request logger middleware for NodeJS, specialized in translating HTTP request into readble and easily customizeable format, and Winston is a general-purpose logger. I used this combination of these libraries to make API logging more convienient.
- Install **morgan**, **winston** and **winston-daily-rotate-file** so I could use rotating File Transport of winston 
    ```cmd
    npm install morgan winston winston-daily-rotate-file
    ```
## 2. Configure winston tranpsports
- I created **utils** folder, inside there were **logger.js** and **loggerHelper.js**  
+ **logger.js**: Where I defined **winston** transport and desired logging format. I used a **Console Transport** for debugging during server's run and development, and a **Daily Rotate File Transport** to store logs for a longer time. Daily Rotate File Transport (from **winston-daily-rotate-file**) offers creating new log file each day, archiving max-sized files before creating a new file for logging and removing out-dated log files based on elapsed days or quantity capacity. 

+ I also chose to log requests that receives **http** level to **error** level responses (based on [npm logging level](https://www.npmjs.com/package/winston#using-logging-levels)):
    ```js
    <!-- npm logging level -->
    {
        error: 0,
        warn: 1,
        info: 2,
        http: 3,
        verbose: 4,
        debug: 5,
        silly: 6
    }
    ```

    ```js
    // utils/logger.js
    import winston from "winston";
    import 'winston-daily-rotate-file'
    const logLevel = 'http';
    const rotateTransportHttp = new winston.transports.DailyRotateFile({
        level: logLevel,
        filename: './logs/application-%DATE%.log',
        datePattern: 'YYYY-MM-DD-HH',
        zippedArchive: true,
        maxSize: '10k',
        maxFiles: '2', //add suffix 'd' to remove outdated files based on elapsed days
        handleExceptions: true,
    })

    const logger = winston.createLogger({
        level: 'http',
        format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json(),
            winston.format.colorize()
        ),
        transports: [
            rotateTransportHttp,
            new winston.transports.Console({
                level:'http'
            })
        ]
    });

    export default logger;

    ```

## 3. Implement morgan helper
- Inside **loggerHelper.js**, I implemented morgan, defining its output format and logic of logging using logger (from **logger.js**) in its stream object.
    ```js
    import morgan from "morgan";
    import logger from "./logger.js"

    morgan.token('req-body', function(req, res){return JSON.stringify(req.body?req.body:'')})
    const loggerHelper = morgan((tokens, req, res ) => {
        return  JSON.stringify({
            status: tokens.status(req, res),
            method: tokens.method(req, res),
            url: tokens.url(req, res),
            contentLength: tokens.res(req, res, 'content-length'),
            responseTime: tokens['response-time'](req, res)+'ms',
            reqBody: tokens['req-body'](req, res)
        })
        
    
    }, {
        stream: {
            write: (message) => {
                const {status, method, url, contentLength, responseTime, reqBody} = JSON.parse(message)
                if (status >= 500){
                    logger.error(`${status} ${method} ${url}`, {contentLength, responseTime, reqBody})
                }else if (status >= 400){
                    logger.warn(`${status} ${method} ${url}`, {contentLength, responseTime, reqBody})
                }else {
                    logger.http(`${status} ${method} ${url}`, {contentLength, responseTime, reqBody})
                }
            }
        }
    }) 


    export default loggerHelper;
    ```
## 4. Integreate helper as middleware in Express Server
- After implementing necessary lines of code, I integrated loggerHelper from loggerHelper.js as a universal middleware so that it could catch all traffic going through my API endpoints.
    ```js
    // index.js

    /* 
        Other imports 
    */
    import loggerHelper from "./utils/loggerHelper.js";
    app.use(express.json());
    app.use(loggerHelper)
    /*
        Other middlewares and routes implementation
    */
    /* 
        Code to run the server 
    */
    ```
## 5. Run the server and test functionality
-  After running the server using `npm run dev`, I ran these sample requests:
    ```js
    <!-- This will receive a 400 Bad Request -->
    POST http://localhost:3000/films
    Content-Type: application/json

    {
        "language_id": 1,
        "rental_duration": 2,
        "rental_rate": 4.99,
        "replacement_cost": 10.99
    }
    <!-- This will receive a 200 OK -->
    POST http://localhost:3000/films
    Content-Type: application/json

    {
        "title": "A new Film",
        "language_id": 1,
        "rental_duration": 2,
        "rental_rate": 4.99,
        "replacement_cost": 10.99
    }
    ```
- Responses from Express Server
    ```js
    <!-- Missing "title" request -->
    HTTP/1.1 400 Bad Request
    X-Powered-By: Express
    Content-Type: application/json; charset=utf-8
    Content-Length: 126
    ETag: W/"7e-VSln7usODpYi5j4TKfpRmNAJDRc"
    Date: Sat, 25 Oct 2025 14:35:17 GMT
    Connection: close

    {
    "msg": [
            {
            "message": "\"title\" is required",
            "path": [
                "title"
            ],
            "type": "any.required",
            "context": {
                "label": "title",
                "key": "title"
            }
            }
        ]
    }
    <!-- No missing required field -->
    HTTP/1.1 200 OK
    X-Powered-By: Express
    Content-Type: application/json; charset=utf-8
    Content-Length: 172
    ETag: W/"ac-rNxb3+FWZ8Sd1QqjDozX1rH4ANY"
    Date: Sat, 25 Oct 2025 14:36:28 GMT
    Connection: close

    {
    "rating": "G",
    "last_update": {
        "val": "CURRENT_TIMESTAMP"
    },
    "film_id": 1035,
    "title": "A new Film",
    "language_id": 1,
    "rental_duration": 2,
    "rental_rate": 4.99,
    "replacement_cost": 10.99
    }
    ```
- What were recorede in **application-DATE.log**
    ```json
    {"contentLength":"126","level":"warn","message":"400 POST /films","reqBody":"{\"language_id\":1,\"rental_duration\":2,\"rental_rate\":4.99,\"replacement_cost\":10.99}","responseTime":"4.058ms","timestamp":"2025-10-25T14:35:17.168Z"}
    {"contentLength":"172","level":"http","message":"200 POST /films","reqBody":"{\"title\":\"A new Film\",\"language_id\":1,\"rental_duration\":2,\"rental_rate\":4.99,\"replacement_cost\":10.99}","responseTime":"68.215ms","timestamp":"2025-10-25T14:36:28.553Z"}

    ```
## 6. How to view logs and find messages.
- To query stored logs, I used PowerShell-Native command:
    + **Get-Content**: Get data inside a *.log file as a string stream 
    + **ConvertFrom-Json**: Convert that string stream into a list of JSON objects
    + **Where-Object**: A command that lets me filter objects (equivalent to a log record) passed by ConvertFrom-Json:
    + **"|" operator**: Combine these command in an exact order to make it a pipeline 
- These are some example of how I queried using the above commands:
    + Log file's content:
    ```js
    {"contentLength":"126","level":"warn","message":"400 POST /films","reqBody":"{\"language_id\":1,\"rental_duration\":2,\"rental_rate\":4.99,\"replacement_cost\":10.99}","responseTime":"4.058ms","timestamp":"2025-10-25T14:35:17.168Z"}
    {"contentLength":"172","level":"http","message":"200 POST /films","reqBody":"{\"title\":\"A new Film\",\"language_id\":1,\"rental_duration\":2,\"rental_rate\":4.99,\"replacement_cost\":10.99}","responseTime":"68.215ms","timestamp":"2025-10-25T14:36:28.553Z"}
    ```
    + Example command and query results:
    ```powershell
    <!-- Command -->
    Get-Content .\logs\application-2025-10-25-21.log | ConvertFrom-Json | Where-Object { $_.message -like '*400*' }
    <!-- Result -->
    contentLength : 126
    level         : warn
    message       : 400 POST /films
    reqBody       : {"language_id":1,"rental_duration":2,"rental_rate":4.99,"replacement_cost":10.99}
    responseTime  : 4.058ms
    timestamp     : 2025-10-25T14:35:17.168Z
    ```
    ```powershell
    <!-- Command -->
    Get-Content .\logs\application-2025-10-25-21.log | ConvertFrom-Json | Where-Object { $_.message -like '*400*' }
    <!-- Result -->
    contentLength : 126
    level         : warn
    message       : 400 POST /films
    reqBody       : {"language_id":1,"rental_duration":2,"rental_rate":4.99,"replacement_cost":10.99}
    responseTime  : 4.058ms
    timestamp     : 2025-10-25T14:35:17.168Z
    ```
    ```powershell
   Get-Content .\logs\application-2025-10-25-21.log | ConvertFrom-Json | Where-Object { $_.level -eq 'warn' -or $_.level -eq 'http' }
    <!-- Result -->
    contentLength : 126
    level         : warn
    message       : 400 POST /films
    reqBody       : {"language_id":1,"rental_duration":2,"rental_rate":4.99,"replacement_cost":10.99}
    responseTime  : 4.058ms
    timestamp     : 2025-10-25T14:35:17.168Z

    contentLength : 172
    level         : http
    message       : 200 POST /films
    reqBody       : {"title":"A new Film","language_id":1,"rental_duration":2,"rental_rate":4.99,"replacement_cost":10.99}
    responseTime  : 68.215ms
    timestamp     : 2025-10-25T14:36:28.553Z
    ```